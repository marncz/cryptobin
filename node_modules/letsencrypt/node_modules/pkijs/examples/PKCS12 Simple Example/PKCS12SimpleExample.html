<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>PKCS#12 Simple Example</title>

    <script type="text/javascript" src="org/pkijs/common.js"></script>
    <script type="text/javascript" src="org/pkijs/asn1.js"></script>
    <script type="text/javascript" src="org/pkijs/x509_schema.js"></script>
    <script type="text/javascript" src="org/pkijs/x509_simpl.js"></script>
    <script type="text/javascript" src="org/pkijs/cms_schema.js"></script>
    <script type="text/javascript" src="org/pkijs/cms_simpl.js"></script>
    <script type="text/javascript" src="org/pkijs/pkcs12_schema.js"></script>
    <script type="text/javascript" src="org/pkijs/pkcs12_simpl.js"></script>

    <style type="text/css">
        body {
            background: #EFEFEF;
            font: normal 14px/16px Helvetica, Arial, sans-serif;
        }

        .wrapper {
            width: 600px;
            margin: 50px auto;
            padding: 50px;
            border: solid 2px #CCC;
            border-radius: 10px;
            -webkit-border-radius: 10px;
            box-shadow: 0 0 12px 3px #CDCDCD;
            -webkit-box-shadow: 0 0 12px 3px #CDCDCD;
            background: #FFF;
        }

        label {
            margin: 0 0 8px;
        }

        textarea {
            width: 500px;
            border: solid 1px #999;
            border-radius: 5px;
            -webkit-border-radius: 5px;
            height: 340px;
            font: normal 12px/15px monospace;
            display: block;
            margin: 0 0 12px;
            box-shadow: 0 0 5px 5px #EFEFEF inset;
            -webkit-box-shadow: 0 0 5px 5px #EFEFEF inset;
            padding: 20px;
            resize: none;
        }

        a {
            display: inline-block;
            padding: 5px 15px;
            background: #ACD0EC;
            border: solid 1px #4C6181;
            color: #000;
            font: normal 14px/16px Helvetica, Arial, sans-serif;
        }

            a:hover {
                background: #DAEBF8;
                cursor: pointer;
            }

        .header-block {
            margin-top: 30px;
            font: bold 16px/20px Helvetica, Arial, sans-serif;
        }

        .border-block {
            border: solid 2px #999;
            border-radius: 5px;
            -webkit-border-radius: 5px;
            margin: 10px 0 0;
            padding: 20px 30px;
            background: #F0F4FF;
        }

            .border-block h2 {
                margin: 0 0 16px;
                font: bold 22px/24px Helvetica, Arial, sans-serif;
            }

            .border-block p {
                margin: 0 0 12px;
            }

                .border-block p .type {
                    font-weight: bold;
                    display: inline-block;
                    width: 176px;
                }

            .border-block .two-col {
                overflow: hidden;
                margin: 0 0 16px;
            }

                .border-block .two-col .subject {
                    width: 180px;
                    font-weight: bold;
                    margin: 0 0 12px;
                    float: left;
                }

                .border-block .two-col #cert-attributes {
                    margin: 0;
                    padding: 0;
                    float: left;
                    list-style: none;
                }

                    .border-block .two-col #cert-attributes li p {
                        margin: 0;
                    }

                        .border-block .two-col #cert-attributes li p span {
                            width: 40px;
                            display: inline-block;
                            margin: 0 0 5px;
                        }

                .border-block .two-col #cert-exten {
                    overflow: hidden;
                    padding: 0 0 0 17px;
                    margin: 0;
                    list-style-type: square;
                }

        table {
            border: solid;
            border-collapse: collapse;
            border-color: black;
        }

        th {
            text-align: center;
            background: #ccc;
            padding: 5px;
            border: 1px solid black;
        }

        td {
            padding: 5px;
            border: 1px solid black;
        }
    </style>

    <script>
        //*********************************************************************************
        // #region Global variables 
        //*********************************************************************************
        var certificateBASE64 = "MIIDRDCCAi6gAwIBAgIBATALBgkqhkiG9w0BAQswODE2MAkGA1UEBhMCVVMwKQYD\
        VQQDHiIAUABlAGMAdQBsAGkAYQByACAAVgBlAG4AdAB1AHIAZQBzMB4XDTEzMDEz\
        MTIxMDAwMFoXDTE2MDEzMTIxMDAwMFowODE2MAkGA1UEBhMCVVMwKQYDVQQDHiIA\
        UABlAGMAdQBsAGkAYQByACAAVgBlAG4AdAB1AHIAZQBzMIIBIjANBgkqhkiG9w0B\
        AQEFAAOCAQ8AMIIBCgKCAQEA4qEnCuFxZqTEM/8cYcaYxexT6+fAHan5/eGCFOe1\
        Yxi0BjRuDooWBPX71+hmWK/MKrKpWTpA3ZDeWrQR2WIcaf/ypd6DAEEWWzlQgBYp\
        EUj/o7cykNwIvZReU9JXCbZu0EmeZXzBm1mIcWYRdk17UdneIRUkU379wVJcKXKl\
        gZsx8395UNeOMk11G5QaHzAafQ1ljEKB/x2xDgwFxNaKpSIq3LQFq0PxoYt/PBJD\
        MfUSiWT5cFh1FdKITXQzxnIthFn+NVKicAWBRaSZCRQxcShX6KHpQ1Lmk0/7QoCc\
        DOAmVSfUAaBl2w8bYpnobFSStyY0RJHBqNtnTV3JonGAHwIDAQABo10wWzAMBgNV\
        HRMEBTADAQH/MAsGA1UdDwQEAwIA/zAdBgNVHQ4EFgQU5QmA6U960XL4SII2SEhC\
        cxij0JYwHwYDVR0jBBgwFoAU5QmA6U960XL4SII2SEhCcxij0JYwCwYJKoZIhvcN\
        AQELA4IBAQAikQls3LhY8rYQCZ+8jXrdaRTY3L5J3S2xzoAofkEnQNzNMClaWrZb\
        Y/KQ+gG25MIFwPOWZn/uYUKB2j0yHTRMPEAp/v5wawSqM2BkdnkGP4r5Etx9pe3m\
        og2xNUBqSeopNNto7QgV0o1yYHtuMKQhNAzcFB1CGz25+lXv8VuuU1PoYNrTjipr\
        kjLDgPurNXUjUh9AZl06+Cakoe75LEkuaZKuBQIMNLJFcM2ZSK/QAAaI0E1Dovcs\
        CctW8x/6Qk5fYwNu0jcIdng9dzKYXytzV53+OGxdK5mldyBBkyvTrbO8bWwYT3c+\
        weB1huNpgnpRHJKMz5xVj0bbdnHir6uc";

        var privateKeyBASE64 = "MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDioScK4XFmpMQz\
        /xxhxpjF7FPr58Adqfn94YIU57VjGLQGNG4OihYE9fvX6GZYr8wqsqlZOkDdkN5a\
        tBHZYhxp//Kl3oMAQRZbOVCAFikRSP+jtzKQ3Ai9lF5T0lcJtm7QSZ5lfMGbWYhx\
        ZhF2TXtR2d4hFSRTfv3BUlwpcqWBmzHzf3lQ144yTXUblBofMBp9DWWMQoH/HbEO\
        DAXE1oqlIirctAWrQ/Ghi388EkMx9RKJZPlwWHUV0ohNdDPGci2EWf41UqJwBYFF\
        pJkJFDFxKFfooelDUuaTT/tCgJwM4CZVJ9QBoGXbDxtimehsVJK3JjREkcGo22dN\
        XcmicYAfAgMBAAECggEBANMO1fdyIVRAWmE6UspUU+7vuvBWMjruE9126NhjOjAB\
        z5Z/uYdc3kjcdSCMVNR/VBrnrINmlwZBZnL+hCj5EBE/xlDnOwU/mHx4khnXiYOJ\
        glqLwFHcOV+lD3vsxhZLikP8a8GEQCJXbZR+RADzA8gkqJQSxnPkLpqeAyqulKhv\
        iQ2lq2ZxeCXI+iZvURQPTSm86+szClwgzr2uW6NSlNKKeeLHMILed4mrwbPOdyhu\
        tnqvV79GUYH3yYdzbEbbw5GOat77+xPLt33cfLCL7pg5lGDrKEomu6V1d5KmBOhv\
        0K8gGPKfxPrpeUG5n1q58k/2ouCiyAaKWpVoOWmnbzECgYEA/UzAGZ2N8YE+kC85\
        Nl0wQof+WVm+RUDsv6C3L2vPUht3GwnbxSTMl4+NixbCWG46udVhsM2x7ZzYY1eB\
        7LtnBnjvXZTYU4wqZtGR/+X2Rw5ou+oWm16/OgcEuFjP2zpQtr9r/bpKhyBV+IdS\
        ngnLy00RueKGUL6nvtecRklEhQ0CgYEA5Quek+c12qMtrmg5znHPQC7uuieZRzUL\
        9jTlQtuZM5m4B3AfB/N/0qIQS06PHS1ijeHQ9SxEmG72weamUYC0SPi8GxJioFza\
        JEDVit0Ra38gf0CXQvcYT0XD1CwY/m+jDXDWL5L1CCIr60AzNjM3WEfGO4VHaNso\
        vVLn1Fvy5tsCgYEA4ZOEUEubqUOsb8NedCexXs61mOTvKcWUEWQTP0wHqduDyrSQ\
        35TSDvds2j0+fnpMGksJYOcOWcmge3fm4OhT69Ovd+uia2UcLczc9MPa+5S9ePwT\
        ffJ24jp13aZaFaZtUxJOHfvVe1k0tsvsq4mV0EumSaCOdUIVKUPijEWbm9ECgYBp\
        Fa+nxAidSwiGYCNFaEnh9KZqmghk9x2J1DLrPb1IQ1p/bx2NlFYs2VYIdv6KMGxr\
        FBO+qJTAKwjjZWMhOZ99a0FCWmkNkgwzXdubXlnDrAvI1mWPv7ZTiHqUObct5SI1\
        5HMgWJg7JxJnWIkmcNEPm76DSF6+6O4EDql2cMk8yQKBgF5roj+l90lfwImr6V1N\
        Jo3J5VCi9wTT5x9enPY9WRcfSyRjqU7JWy6h0C+Jq+AYAxrkQVjQuv1AOhO8Uhc6\
        amM5FA+gfg5HKKPnwuOe7r7B48LFF8eRjYRtHmrQUrFY0jH6O+t12dEQI+7qE+Sf\
        fUScsZWCREX7QYEK/tuznv/U";
        //*********************************************************************************
        // #endregion 
        //*********************************************************************************
        // #region Auxiliary functions 
        //*********************************************************************************
        function formatPEM(pem_string)
        {
            /// <summary>Format string in order to have each line with length equal to 63</summary>
            /// <param name="pem_string" type="String">String to format</param>

            var string_length = pem_string.length;
            var result_string = "";

            for(var i = 0, count = 0; i < string_length; i++, count++)
            {
                if(count > 63)
                {
                    result_string = result_string + "\r\n";
                    count = 0;
                }

                result_string = result_string + pem_string[i];
            }

            return result_string;
        }
        //*********************************************************************************
        function arrayBufferToString(buffer)
        {
            /// <summary>Create a string from ArrayBuffer</summary>
            /// <param name="buffer" type="ArrayBuffer">ArrayBuffer to create a string from</param>

            var result_string = "";
            var view = new Uint8Array(buffer);

            for(var i = 0; i < view.length; i++)
                result_string = result_string + String.fromCharCode(view[i]);

            return result_string;
        }
        //*********************************************************************************
        function stringToArrayBuffer(str)
        {
            /// <summary>Create an ArrayBuffer from string</summary>
            /// <param name="str" type="String">String to create ArrayBuffer from</param>

            var stringLength = str.length;

            var resultBuffer = new ArrayBuffer(stringLength);
            var resultView = new Uint8Array(resultBuffer);

            for(var i = 0; i < stringLength; i++)
                resultView[i] = str.charCodeAt(i);

            return resultBuffer;
        }
        //*********************************************************************************
        function destroyClickedElement(event)
        {
            document.body.removeChild(event.target);
        }
        //*********************************************************************************
        // #endregion 
        //*********************************************************************************
        function passwordBasedIntegrity(password)
        {
            // #region Initial variables 
            var sequence = Promise.resolve();

            if(typeof password == "undefined")
                password = document.getElementById("password2").value;
            // #endregion 

            // #region Create simplified structires for certificate and private key 
            var asn1 = org.pkijs.fromBER(stringToArrayBuffer(window.atob(certificateBASE64)));
            var cert_simpl = new org.pkijs.simpl.CERT({ schema: asn1.result });

            asn1 = org.pkijs.fromBER(stringToArrayBuffer(window.atob(privateKeyBASE64)));
            var pkcs8_simpl = new org.pkijs.simpl.PKCS8({ schema: asn1.result });
            // #endregion 

            // #region Put initial values for PKCS#12 structures 
            var pkcs12 = new org.pkijs.simpl.PKCS12({
                parsedValue: {
                    integrityMode: 0, // Password-Based Integrity Mode
                    authenticatedSafe: new org.pkijs.simpl.pkcs12.AuthenticatedSafe({
                        parsedValue: {
                            safeContents: [
                                {
                                    privacyMode: 0, // "No Privacy" mode
                                    value: new org.pkijs.simpl.pkcs12.SafeContents({
                                        safeBags: [
                                            new org.pkijs.simpl.pkcs12.SafeBag({
                                                bagId: "1.2.840.113549.1.12.10.1.1",
                                                bagValue: pkcs8_simpl
                                            }),
                                            new org.pkijs.simpl.pkcs12.SafeBag({
                                                bagId: "1.2.840.113549.1.12.10.1.3",
                                                bagValue: new org.pkijs.simpl.pkcs12.CertBag({
                                                    parsedValue: cert_simpl
                                                })
                                            })
                                        ]
                                    })
                                }
                            ]
                        }
                    })
                }
            });
            // #endregion 

            // #region Encode internal values for all "SafeContents" firts (create all "Privacy Protection" envelopes) 
            sequence = sequence.then(
                function(result)
                {
                    return pkcs12.parsedValue.authenticatedSafe.makeInternalValues({
                        safeContents: [
                            {
                                // Empty parameters since we have "No Privacy" protection level for SafeContents
                            }
                        ]
                    });
                }
                );
            // #endregion 

            // #region Encode internal values for "Integrity Protection" envelope 
            sequence = sequence.then(
                function()
                {
                    return pkcs12.makeInternalValues({
                        password: stringToArrayBuffer(password),
                        iterations: 100000,
                        pbkdf2HashAlgorithm: "SHA-256", // Least two parameters are equal because at the moment it is not clear how to use PBMAC1 schema with PKCS#12 integrity protection
                        hmacHashAlgorithm: "SHA-256"
                    });
                }
                );
            // #endregion 

            // #region Save encoded data 
            sequence = sequence.then(
                function()
                {
                    var pkcs12AsBlob = new Blob([pkcs12.toSchema().toBER(false)], { type: 'application/x-pkcs12' });
                    var downloadLink = document.createElement("a");
                    downloadLink.download = "pkijs_pkcs12.p12";
                    downloadLink.innerHTML = "Download File";

                    downloadLink.href = window.URL.createObjectURL(pkcs12AsBlob);
                    downloadLink.onclick = destroyClickedElement;
                    downloadLink.style.display = "none";
                    document.body.appendChild(downloadLink);

                    downloadLink.click();
                }
                );
            // #endregion 
        }
        //*********************************************************************************
        function certificateBasedIntegrity()
        {
            // #region Initial variables 
            var sequence = Promise.resolve();
            // #endregion 

            // #region Create simplified structires for certificate and private key 
            var asn1 = org.pkijs.fromBER(stringToArrayBuffer(window.atob(certificateBASE64)));
            var cert_simpl = new org.pkijs.simpl.CERT({ schema: asn1.result });

            asn1 = org.pkijs.fromBER(stringToArrayBuffer(window.atob(privateKeyBASE64)));
            var pkcs8_simpl = new org.pkijs.simpl.PKCS8({ schema: asn1.result });
            // #endregion 

            // #region Get a "crypto" extension 
            var crypto = org.pkijs.getCrypto();
            if(typeof crypto == "undefined")
            {
                alert("No WebCrypto extension found");
                return;
            }
            // #endregion 

            // #region Put initial values for PKCS#12 structures 
            var pkcs12 = new org.pkijs.simpl.PKCS12({
                parsedValue: {
                    integrityMode: 1, // Certificate-Based Integrity Mode
                    authenticatedSafe: new org.pkijs.simpl.pkcs12.AuthenticatedSafe({
                        parsedValue: {
                            safeContents: [
                                {
                                    privacyMode: 0, // "No Privacy" mode
                                    value: new org.pkijs.simpl.pkcs12.SafeContents({
                                        safeBags: [
                                            new org.pkijs.simpl.pkcs12.SafeBag({
                                                bagId: "1.2.840.113549.1.12.10.1.1",
                                                bagValue: pkcs8_simpl
                                            }),
                                            new org.pkijs.simpl.pkcs12.SafeBag({
                                                bagId: "1.2.840.113549.1.12.10.1.3",
                                                bagValue: new org.pkijs.simpl.pkcs12.CertBag({
                                                    parsedValue: cert_simpl
                                                })
                                            })
                                        ]
                                    })
                                }
                            ]
                        }
                    })
                }
            });
            // #endregion 

            // #region Encode internal values for all "SafeContents" firts (create all "Privacy Protection" envelopes) 
            sequence = sequence.then(
                function(result)
                {
                    return pkcs12.parsedValue.authenticatedSafe.makeInternalValues({
                        safeContents: [
                            {
                                // Empty parameters since we have "No Privacy" protection level for SafeContents
                            }
                        ]
                    });
                }
                );
            // #endregion 

            // #region Import PKCS#8 key into WebCrypto key 
            sequence = sequence.then(
                function()
                {
                    return cert_simpl.getPublicKey().then(
                        function(result)
                        {
                            var algorithm = org.pkijs.getAlgorithmParameters(result.algorithm.name, "importkey");

                            return crypto.importKey("pkcs8",
                                stringToArrayBuffer(window.atob(privateKeyBASE64)),
                                algorithm.algorithm,
                                true,
                                ["sign"]);
                        }
                        );
                }
                );
            // #endregion 

            // #region Encode internal values for "Integrity Protection" envelope 
            sequence = sequence.then(
                function(result)
                {
                    return pkcs12.makeInternalValues({
                        signingCertificate: cert_simpl,
                        privateKey: result,
                        hashAlgorithm: "SHA-256"
                    });
                }
                );
            // #endregion 

            // #region Save encoded data 
            sequence = sequence.then(
                function()
                {
                    var pkcs12AsBlob = new Blob([pkcs12.toSchema().toBER(false)], { type: 'application/x-pkcs12' });
                    var downloadLink = document.createElement("a");
                    downloadLink.download = "pkijs_pkcs12.p12";
                    downloadLink.innerHTML = "Download File";

                    downloadLink.href = window.URL.createObjectURL(pkcs12AsBlob);
                    downloadLink.onclick = destroyClickedElement;
                    downloadLink.style.display = "none";
                    document.body.appendChild(downloadLink);

                    downloadLink.click();
                }
                );
            // #endregion 
        }
        //*********************************************************************************
        function noPrivacy()
        {
            passwordBasedIntegrity(document.getElementById("password3").value); // Same with previous example
        }
        //*********************************************************************************
        function passwordPrivacy()
        {
            // #region Initial variables 
            var sequence = Promise.resolve();
            // #endregion 

            // #region Create simplified structires for certificate and private key 
            var asn1 = org.pkijs.fromBER(stringToArrayBuffer(window.atob(certificateBASE64)));
            var cert_simpl = new org.pkijs.simpl.CERT({ schema: asn1.result });

            asn1 = org.pkijs.fromBER(stringToArrayBuffer(window.atob(privateKeyBASE64)));
            var pkcs8_simpl = new org.pkijs.simpl.PKCS8({ schema: asn1.result });
            // #endregion 

            // #region Put initial values for PKCS#12 structures 
            var pkcs12 = new org.pkijs.simpl.PKCS12({
                parsedValue: {
                    integrityMode: 0, // Password-Based Integrity Mode
                    authenticatedSafe: new org.pkijs.simpl.pkcs12.AuthenticatedSafe({
                        parsedValue: {
                            safeContents: [
                                {
                                    privacyMode: 1, // Password-Based Privacy Protection Mode
                                    value: new org.pkijs.simpl.pkcs12.SafeContents({
                                        safeBags: [
                                            new org.pkijs.simpl.pkcs12.SafeBag({
                                                bagId: "1.2.840.113549.1.12.10.1.1",
                                                bagValue: pkcs8_simpl
                                            }),
                                            new org.pkijs.simpl.pkcs12.SafeBag({
                                                bagId: "1.2.840.113549.1.12.10.1.3",
                                                bagValue: new org.pkijs.simpl.pkcs12.CertBag({
                                                    parsedValue: cert_simpl
                                                })
                                            })
                                        ]
                                    })
                                }
                            ]
                        }
                    })
                }
            });
            // #endregion 

            // #region Encode internal values for all "SafeContents" firts (create all "Privacy Protection" envelopes) 
            sequence = sequence.then(
                function(result)
                {
                    return pkcs12.parsedValue.authenticatedSafe.makeInternalValues({
                        safeContents: [
                            {
                                password: stringToArrayBuffer(document.getElementById("password4").value),
                                contentEncryptionAlgorithm: {
                                    name: "AES-CBC",
                                    length: 128
                                },
                                hmacHashAlgorithm: "SHA-256",
                                iterationCount: 2048
                            }
                        ]
                    });
                }
                );
            // #endregion 

            // #region Encode internal values for "Integrity Protection" envelope 
            sequence = sequence.then(
                function()
                {
                    return pkcs12.makeInternalValues({
                        password: stringToArrayBuffer(document.getElementById("password4").value),
                        iterations: 100000,
                        pbkdf2HashAlgorithm: "SHA-256", // Least two parameters are equal because at the moment it is not clear how to use PBMAC1 schema with PKCS#12 integrity protection
                        hmacHashAlgorithm: "SHA-256"
                    });
                }
                );
            // #endregion 

            // #region Save encoded data 
            sequence = sequence.then(
                function()
                {
                    var pkcs12AsBlob = new Blob([pkcs12.toSchema().toBER(false)], { type: 'application/x-pkcs12' });
                    var downloadLink = document.createElement("a");
                    downloadLink.download = "pkijs_pkcs12.p12";
                    downloadLink.innerHTML = "Download File";

                    downloadLink.href = window.URL.createObjectURL(pkcs12AsBlob);
                    downloadLink.onclick = destroyClickedElement;
                    downloadLink.style.display = "none";
                    document.body.appendChild(downloadLink);

                    downloadLink.click();
                }
                );
            // #endregion 
        }
        //*********************************************************************************
        function certificatePrivacy()
        {
            // #region Initial variables 
            var sequence = Promise.resolve();
            // #endregion 

            // #region Create simplified structires for certificate and private key 
            var asn1 = org.pkijs.fromBER(stringToArrayBuffer(window.atob(certificateBASE64)));
            var cert_simpl = new org.pkijs.simpl.CERT({ schema: asn1.result });

            asn1 = org.pkijs.fromBER(stringToArrayBuffer(window.atob(privateKeyBASE64)));
            var pkcs8_simpl = new org.pkijs.simpl.PKCS8({ schema: asn1.result });
            // #endregion 

            // #region Put initial values for PKCS#12 structures 
            var pkcs12 = new org.pkijs.simpl.PKCS12({
                parsedValue: {
                    integrityMode: 0, // Password-Based Integrity Mode
                    authenticatedSafe: new org.pkijs.simpl.pkcs12.AuthenticatedSafe({
                        parsedValue: {
                            safeContents: [
                                {
                                    privacyMode: 2, // Certificate-Based Privacy Protection Mode
                                    value: new org.pkijs.simpl.pkcs12.SafeContents({
                                        safeBags: [
                                            new org.pkijs.simpl.pkcs12.SafeBag({
                                                bagId: "1.2.840.113549.1.12.10.1.1",
                                                bagValue: pkcs8_simpl
                                            }),
                                            new org.pkijs.simpl.pkcs12.SafeBag({
                                                bagId: "1.2.840.113549.1.12.10.1.3",
                                                bagValue: new org.pkijs.simpl.pkcs12.CertBag({
                                                    parsedValue: cert_simpl
                                                })
                                            })
                                        ]
                                    })
                                }
                            ]
                        }
                    })
                }
            });
            // #endregion 

            // #region Encode internal values for all "SafeContents" firts (create all "Privacy Protection" envelopes) 
            sequence = sequence.then(
                function(result)
                {
                    return pkcs12.parsedValue.authenticatedSafe.makeInternalValues({
                        safeContents: [
                            {
                                encryptingCertificate: cert_simpl,
                                encryptionAlgorithm: {
                                    name: "AES-CBC",
                                    length: 128
                                }
                            }
                        ]
                    });
                }
                );
            // #endregion 

            // #region Encode internal values for "Integrity Protection" envelope 
            sequence = sequence.then(
                function()
                {
                    return pkcs12.makeInternalValues({
                        password: stringToArrayBuffer(document.getElementById("password5").value),
                        iterations: 100000,
                        pbkdf2HashAlgorithm: "SHA-256", // Least two parameters are equal because at the moment it is not clear how to use PBMAC1 schema with PKCS#12 integrity protection
                        hmacHashAlgorithm: "SHA-256"
                    });
                }
                );
            // #endregion 

            // #region Save encoded data 
            sequence = sequence.then(
                function()
                {
                    var pkcs12AsBlob = new Blob([pkcs12.toSchema().toBER(false)], { type: 'application/x-pkcs12' });
                    var downloadLink = document.createElement("a");
                    downloadLink.download = "pkijs_pkcs12.p12";
                    downloadLink.innerHTML = "Download File";

                    downloadLink.href = window.URL.createObjectURL(pkcs12AsBlob);
                    downloadLink.onclick = destroyClickedElement;
                    downloadLink.style.display = "none";
                    document.body.appendChild(downloadLink);

                    downloadLink.click();
                }
                );
            // #endregion 
        }
        //*********************************************************************************
        function openSSLLike()
        {
            // #region Initial variables 
            var sequence = Promise.resolve();

            var keyLocalIDBuffer = new ArrayBuffer(4);
            var keyLocalIDView = new Uint8Array(keyLocalIDBuffer);

            org.pkijs.getRandomValues(keyLocalIDView);

            var certLocalIDBuffer = new ArrayBuffer(4);
            var certLocalIDView = new Uint8Array(certLocalIDBuffer);

            org.pkijs.getRandomValues(certLocalIDView);

            // #region "KeyUsage" attribute 
            var bit_array = new ArrayBuffer(1);
            var bit_view = new Uint8Array(bit_array);

            bit_view[0] = bit_view[0] | 0x80;

            var key_usage = new org.pkijs.asn1.BITSTRING({
                value_hex: bit_array,
                unused_bits: 7
            });
            // #endregion 
            // #endregion 

            // #region Create simplified structires for certificate and private key 
            var asn1 = org.pkijs.fromBER(stringToArrayBuffer(window.atob(certificateBASE64)));
            var cert_simpl = new org.pkijs.simpl.CERT({ schema: asn1.result });

            asn1 = org.pkijs.fromBER(stringToArrayBuffer(window.atob(privateKeyBASE64)));
            var pkcs8_simpl = new org.pkijs.simpl.PKCS8({ schema: asn1.result });

            // #region Add "keyUsage" attribute 
            pkcs8_simpl.attributes = [
                new org.pkijs.simpl.ATTRIBUTE({
                    type: "2.5.29.15",
                    values: [
                        key_usage
                    ]
                })
            ];
            // #endregion 
            // #endregion 

            // #region Put initial values for PKCS#12 structures 
            var pkcs12 = new org.pkijs.simpl.PKCS12({
                parsedValue: {
                    integrityMode: 0, // Password-Based Integrity Mode
                    authenticatedSafe: new org.pkijs.simpl.pkcs12.AuthenticatedSafe({
                        parsedValue: {
                            safeContents: [
                                {
                                    privacyMode: 0, // "No-privacy" Protection Mode
                                    value: new org.pkijs.simpl.pkcs12.SafeContents({
                                        safeBags: [
                                            new org.pkijs.simpl.pkcs12.SafeBag({
                                                bagId: "1.2.840.113549.1.12.10.1.2",
                                                bagValue: new org.pkijs.simpl.pkcs12.PKCS8ShroudedKeyBag({
                                                    parsedValue: pkcs8_simpl
                                                }),
                                                bagAttributes: [
                                                    new org.pkijs.simpl.cms.Attribute({
                                                        attrType: "1.2.840.113549.1.9.20", // friendlyName
                                                        attrValues: [
                                                            new org.pkijs.asn1.BMPSTRING({ value: "PKCS8ShroudedKeyBag from PKIjs" })
                                                        ]
                                                    }),
                                                    new org.pkijs.simpl.cms.Attribute({
                                                        attrType: "1.2.840.113549.1.9.21", // localKeyID
                                                        attrValues: [
                                                            new org.pkijs.asn1.OCTETSTRING({ value_hex: keyLocalIDBuffer })
                                                        ]
                                                    }),
                                                    new org.pkijs.simpl.cms.Attribute({
                                                        attrType: "1.3.6.1.4.1.311.17.1", // pkcs12KeyProviderNameAttr
                                                        attrValues: [
                                                            new org.pkijs.asn1.BMPSTRING({ value: "http://www.pkijs.org" })
                                                        ]
                                                    })
                                                ]
                                            })
                                        ]
                                    })
                                },
                                {
                                    privacyMode: 1, // Password-Based Privacy Protection Mode
                                    value: new org.pkijs.simpl.pkcs12.SafeContents({
                                        safeBags: [
                                            new org.pkijs.simpl.pkcs12.SafeBag({
                                                bagId: "1.2.840.113549.1.12.10.1.3",
                                                bagValue: new org.pkijs.simpl.pkcs12.CertBag({
                                                    parsedValue: cert_simpl
                                                }),
                                                bagAttributes: [
                                                    new org.pkijs.simpl.cms.Attribute({
                                                        attrType: "1.2.840.113549.1.9.20", // friendlyName
                                                        attrValues: [
                                                            new org.pkijs.asn1.BMPSTRING({ value: "CertBag from PKIjs" })
                                                        ]
                                                    }),
                                                    new org.pkijs.simpl.cms.Attribute({
                                                        attrType: "1.2.840.113549.1.9.21", // localKeyID
                                                        attrValues: [
                                                            new org.pkijs.asn1.OCTETSTRING({ value_hex: certLocalIDBuffer })
                                                        ]
                                                    }),
                                                    new org.pkijs.simpl.cms.Attribute({
                                                        attrType: "1.3.6.1.4.1.311.17.1", // pkcs12KeyProviderNameAttr
                                                        attrValues: [
                                                            new org.pkijs.asn1.BMPSTRING({ value: "http://www.pkijs.org" })
                                                        ]
                                                    })
                                                ]
                                            })
                                        ]
                                    })
                                }
                            ]
                        }
                    })
                }
            });
            // #endregion 

            // #region Encode internal values for "PKCS8ShroudedKeyBag" 
            sequence = sequence.then(
                function()
                {
                    return pkcs12.parsedValue.authenticatedSafe.parsedValue.safeContents[0].value.safeBags[0].bagValue.makeInternalValues({
                        password: stringToArrayBuffer(document.getElementById("password1").value),
                        contentEncryptionAlgorithm: {
                            name: "AES-CBC", // OpenSSL can handle AES-CBC only
                            length: 128 
                        },
                        hmacHashAlgorithm: "SHA-1", // OpenSSL can handle SHA-1 only
                        iterationCount: 100000
                    });
                }
                );
            // #endregion 

            // #region Encode internal values for all "SafeContents" firts (create all "Privacy Protection" envelopes) 
            sequence = sequence.then(
                function(result)
                {
                    return pkcs12.parsedValue.authenticatedSafe.makeInternalValues({
                        safeContents: [
                            {
                                // Empty parameters for first SafeContent since "No Privacy" protection mode there
                            },
                            {
                                password: stringToArrayBuffer(document.getElementById("password1").value),
                                contentEncryptionAlgorithm: {
                                    name: "AES-CBC", // OpenSSL can handle AES-CBC only
                                    length: 128
                                },
                                hmacHashAlgorithm: "SHA-1", // OpenSSL can handle SHA-1 only
                                iterationCount: 100000
                            }
                        ]
                    });
                }
                );
            // #endregion 

            // #region Encode internal values for "Integrity Protection" envelope 
            sequence = sequence.then(
                function()
                {
                    return pkcs12.makeInternalValues({
                        password: stringToArrayBuffer(document.getElementById("password1").value),
                        iterations: 100000,
                        pbkdf2HashAlgorithm: "SHA-256", // OpenSSL can not handle usage of PBKDF2, only PBKDF1
                        hmacHashAlgorithm: "SHA-256"
                    });
                }
                );
            // #endregion 

            // #region Save encoded data 
            sequence = sequence.then(
                function()
                {
                    var pkcs12AsBlob = new Blob([pkcs12.toSchema().toBER(false)], { type: 'application/x-pkcs12' });
                    var downloadLink = document.createElement("a");
                    downloadLink.download = "pkijs_pkcs12.p12";
                    downloadLink.innerHTML = "Download File";

                    downloadLink.href = window.URL.createObjectURL(pkcs12AsBlob);
                    downloadLink.onclick = destroyClickedElement;
                    downloadLink.style.display = "none";
                    document.body.appendChild(downloadLink);

                    downloadLink.click();
                }
                );
            // #endregion 
        }
        //*********************************************************************************
        function parsePKCS12(buffer)
        {
            // #region Initial variables 
            var sequence = Promise.resolve();
            // #endregion 

            // #region Parse internal PKCS#12 values 
            var asn1 = org.pkijs.fromBER(buffer);
            var pkcs12 = new org.pkijs.simpl.PKCS12({ schema: asn1.result });
            // #endregion 

            // #region Parse "AuthenticatedSafe" value of PKCS#12 data  
            sequence = sequence.then(
                function()
                {
                    return pkcs12.parseInternalValues({
                        password: stringToArrayBuffer(document.getElementById("password").value),
                        checkIntegrity: false // Do not check an integrity since OpenSSL produce HMAC using old PBKDF1 function
                    });
                }
                );
            // #endregion 

            // #region Parse "SafeContents" values 
            sequence = sequence.then(
                function()
                {
                    return pkcs12.parsedValue.authenticatedSafe.parseInternalValues({
                        safeContents: [
                            {
                                // Empty parameters since for first "SafeContent" OpenSSL uses "no privacy" protection mode
                            },
                            {
                                password: stringToArrayBuffer(document.getElementById("password").value)
                            }
                        ]
                    });
                }
                );
            // #endregion 

            // #region Parse "PKCS8ShroudedKeyBag" value 
            sequence = sequence.then(
                function()
                {
                    return pkcs12.parsedValue.authenticatedSafe.parsedValue.safeContents[0].value.safeBags[0].bagValue.parseInternalValues({
                        password: stringToArrayBuffer(document.getElementById("password").value)
                    })
                }
                );
            // #endregion 

            // #region Store parsed value to Web page 
            sequence = sequence.then(
                function()
                {
                    // #region Initial variables 
                    var result = "";
                    // #endregion 

                    // #region Store X.509 certificate value 
                    var certificateBuffer = pkcs12.parsedValue.authenticatedSafe.parsedValue.safeContents[1].value.safeBags[0].bagValue.parsedValue.toSchema().toBER(false);

                    result += "-----BEGIN CERTIFICATE-----\r\n";
                    result += formatPEM(window.btoa(arrayBufferToString(certificateBuffer)));
                    result += "\r\n-----END CERTIFICATE-----\r\n";
                    // #endregion 

                    // #endregion Store PKCS#8 (private key) value
                    var pkcs8Buffer = pkcs12.parsedValue.authenticatedSafe.parsedValue.safeContents[0].value.safeBags[0].bagValue.parsedValue.toSchema().toBER(false);

                    result += "\r\n-----BEGIN PRIVATE KEY-----\r\n";
                    result += formatPEM(window.btoa(arrayBufferToString(pkcs8Buffer)));
                    result += "\r\n-----END PRIVATE KEY-----\r\n";
                    // #endregion 

                    document.getElementById("parsing_result").innerHTML = result;
                }
                );
            // #endregion 

        }
        //*********************************************************************************
        function handlePKCS12(evt)
        {
            var temp_reader = new FileReader();

            var current_files = evt.target.files;

            temp_reader.onload =
            function(event)
            {
                parsePKCS12(event.target.result);
            };

            temp_reader.readAsArrayBuffer(current_files[0]);
        }
        //*********************************************************************************
    </script>
</head>
<body>
    <div class="wrapper">
        <fieldset>
            <legend>NOTE</legend>
            <div>
                <p>PKIjs supports many different combinations of PKCS#12. Most clients only support one combination. Clients typically only support a combination where the same password is used for protection and integrity.</p>

                <p>PKIjs, also only supports creation of AES-CBC and AES-GCM protected PKCS#12’s which will not be readable by Windows which only supports weak ciphers in PKCS#12 files.</p>

                <p>You can parse the Password-Based Privacy Protection variant PKIjs creates using this command:</p>

                <p>openssl pkcs12 -in pkijs_pkcs12.p12 -nomacver</p>
            </div>
        </fieldset>
    </div>

    <div class="wrapper">
        <div>
            <fieldset>
                <legend>PKCS#12 With OpenSSL-like Internal Structure</legend>

                <p>
                    <label for="password1" style="float:left;">Password:</label>
                    <input id="password1" type="text" />
                </p>

                <button onclick="openSSLLike();">Create</button>
            </fieldset>
        </div>

        <div>
            <fieldset>
                <legend>PKCS#12 With Password-Based Integrity Protection And No Privacy Protection</legend>

                <p>
                    <label for="password2" style="float:left;">Password:</label>
                    <input id="password2" type="text" />
                </p>

                <button onclick="passwordBasedIntegrity();">Create</button>
            </fieldset>
        </div>

        <div>
            <fieldset>
                <legend>PKCS#12 With Certificate-Based Integrity Protection And No Privacy Protection</legend>
                <button onclick="certificateBasedIntegrity();">Create</button>
            </fieldset>
        </div>

        <div>
            <fieldset>
                <legend>PKCS#12 With No Privacy Protection and Password-Based Integrity Protection</legend>

                <p>
                    <label for="password3" style="float:left;">Password:</label>
                    <input id="password3" type="text" />
                </p>

                <button onclick="noPrivacy();">Create</button>
            </fieldset>
        </div>

        <div>
            <fieldset>
                <legend>PKCS#12 With Password-Based Privacy And Inegrity Protection</legend>

                <p>
                    <label for="password4" style="float:left;">Password:</label>
                    <input id="password4" type="text" />
                </p>

                <button onclick="passwordPrivacy();">Create</button>
            </fieldset>
        </div>

        <div>
            <fieldset>
                <legend>PKCS#12 With Certificate-Based Privacy And Password-Based Integrity Protection</legend>

                <p>
                    <label for="password5" style="float:left;">Password:</label>
                    <input id="password5" type="text" />
                </p>

                <button onclick="certificatePrivacy();">Create</button>
            </fieldset>
        </div>
    </div>

    <div class="wrapper">
        <fieldset>
            <legend>Parse OpenSSL-like PKCS#12 data</legend>

            <fieldset>
                <legend>NOTE</legend>
                <div>
                    <p>Unfortunately current versions of Windows and OpenSSL only support using weak cryptographic primitives in PKCS#12. WebCrypto does not support these weaker mechanisms so we can not fully parse files all files created by them.</p>

                    <p>With that said OpenSSL does support some stronger options, specifically it allows creation of PKCS#12’s using AES-CBC. You can create such a file with this command:</p>

                    <p>openssl pkcs12 -export -inkey key.pem -in test.cer -out test.p12 -certpbe AES-256-CBC -keypbe AES-256-CBC</p>
                </div>
            </fieldset>
            <p>
                <label for="password" style="float:left;">Password:</label>
                <input id="password" type="text" />
            </p>

            <p>
                <label for="pkcs12_file">Select binary PKCS#12 file:</label>
                <input type="file" id="pkcs12_file" title="PKCS#12 data" />
            </p>

            <label for="parsing_result" style="float:left;">BASE-64 decoded certificate + PKCS#8 private key:</label>
            <textarea id="parsing_result">&lt; PKCS#12 parsing result will be stored here &gt;</textarea>
        </fieldset>
    </div>

    <script>
        document.getElementById('pkcs12_file').addEventListener('change', handlePKCS12, false);
    </script>
</body>
</html>
